<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CF Stories ‚Ä¢ Aotearoa</title>
<meta name="description" content="Full CF write-ups with Markdown‚Äîsearch, filter, favourites, and deep links." />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Outfit:wght@600;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0b0f;--panel:#0d1117;--muted:#aeb3bd;--text:#e8ecf1;--line:#1b2230;--rose:#ff4d6d;--sky:#3aa0ff;--mint:#2dd4bf}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
background:radial-gradient(900px 600px at -10% -10%, rgba(255,77,109,.12), transparent 60%),
           radial-gradient(900px 600px at 110% 110%, rgba(58,160,255,.12), transparent 60%),
           linear-gradient(180deg,#07080c 0%,#0a0b0f 40%,#0b0f18 100%)}
a{color:#93c5fd}
header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);background:rgba(8,10,15,.55);border-bottom:1px solid var(--line)}
.container{max-width:1100px;margin:0 auto;padding:16px 18px}
.brand{display:flex;align-items:center;gap:10px;font-family:Outfit,Inter,sans-serif;font-weight:900;letter-spacing:.3px}
.pulse{width:18px;height:18px;border-radius:50%;background:var(--mint);position:relative;box-shadow:0 0 0 0 rgba(45,212,191,.6);animation:pulse 2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(45,212,191,.6)}70%{box-shadow:0 0 0 14px rgba(45,212,191,0)}100%{box-shadow:0 0 0 0 rgba(45,212,191,0)}}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:#0e131b;color:var(--text);text-decoration:none;cursor:pointer;transition:transform .15s,box-shadow .2s;font-size:14px}
.btn:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(0,0,0,.25)}
.icon-btn{width:40px;height:40px;display:grid;place-items:center;border-radius:12px}
.seg{display:flex;gap:6px;flex-wrap:wrap;padding:6px;border-radius:12px;background:#0b0f17;border:1px solid var(--line)}
.seg button{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
.seg button.active{background:#111826;color:#fff;border-color:#1c2433}
.search{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#0d121b;color:var(--text);min-width:260px}
.search input{width:100%;background:transparent;border:none;outline:none;color:inherit;font-size:16px}
.grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px}
@media(min-width:860px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.card{position:relative;overflow:hidden;border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,#0f1520,#0c1019);padding:18px;isolation:isolate;transition:transform .15s,box-shadow .2s,border-color .2s}
.card:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(0,0,0,.35);border-color:#273247}
.badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.muted{color:var(--muted)}
dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
dialog{width:min(820px,92vw);max-height:82vh;border:none;border-radius:16px;background:#0b0f16;color:var(--text);padding:0;overflow:hidden}
.dlg-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
.dlg-body{padding:20px;overflow:auto;white-space:normal;line-height:1.75;font-size:1.02rem}
.dlg-body h1,h2,h3{margin:1em 0 .5em}
.dlg-body blockquote{margin:.6em 0;padding-left:12px;border-left:3px solid #334155;color:#cbd5e1}
.dlg-body code{background:#0f172a;padding:2px 6px;border-radius:6px;font-family:ui-monospace,Menlo,monospace}
.progress{height:3px;background:#1b2230;position:relative}
.progress .bar{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--mint),var(--sky))}
.fab{position:fixed;right:16px;bottom:16px;z-index:60}
.footer{padding:30px 18px;border-top:1px solid var(--line);color:var(--muted)}
.theme-light{--text:#0b1220;--muted:#5a6475;--panel:#f6f8fb}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;gap:14px;">
    <div class="brand"><span class="pulse" aria-hidden="true"></span><span>CF Stories ‚Ä¢ Aotearoa</span></div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <button id="themeBtn" class="btn icon-btn" title="Toggle theme">üåì</button>
      <a class="btn" href="#resources">Resources</a>
    </div>
  </div>
</header>

<main>
  <section class="container" style="padding:38px 18px 10px">
    <h1 style="font-family:Outfit,Inter,sans-serif;font-size:clamp(28px,4vw,48px);margin:0 0 10px">Full write-ups with Markdown. Fast, clean, and shareable.</h1>
    <p class="muted" style="max-width:760px;margin:6px 0 0">Search feelings, filter by tags, save favourites, deep-link to any piece, and switch themes. No names ‚Äî just truth.</p>

    <div style="display:flex;gap:10px;margin-top:18px;flex-wrap:wrap">
      <label class="search" aria-label="Search posts">
        <span aria-hidden="true">üîé</span>
        <input id="search" type="text" placeholder="Search words, feelings, topics‚Ä¶" />
      </label>
      <div id="seg" class="seg" role="tablist" aria-label="Filters"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="importBtn" class="btn">Import JSON</button>
        <button id="exportBtn" class="btn">Export JSON</button>
        <button id="clearLocal" class="btn" title="Clear local edits">Reset Local</button>
      </div>
    </div>
  </section>

  <section class="container" style="padding:18px">
    <div id="grid" class="grid" aria-live="polite"></div>
  </section>

  <section id="resources" class="container" style="padding:8px 18px 48px">
    <h2 style="margin:0 0 12px">Resources (Aotearoa)</h2>
    <div class="grid">
      <div class="card"><b>Cystic Fibrosis NZ</b><p class="muted">Support, info, and community for people with CF and their whƒÅnau.</p><a class="btn" target="_blank" rel="noopener" href="https://www.cfnz.org.nz">Open</a></div>
      <div class="card"><b>Healthline</b><p class="muted">Free 24/7 health advice from registered nurses across NZ.</p><a class="btn" target="_blank" rel="noopener" href="https://www.health.govt.nz">Open</a></div>
      <div class="card"><b>Mental Health Support</b><p class="muted">If you‚Äôre struggling, talk to someone. 1737 (call/text) is free 24/7.</p><a class="btn" target="_blank" rel="noopener" href="https://1737.org.nz/">Open</a></div>
    </div>
  </section>
</main>

<dialog id="reader" aria-labelledby="dlg-title">
  <div class="progress"><div id="bar" class="bar"></div></div>
  <div class="dlg-head">
    <div id="dlg-title" style="font-weight:800">Title</div>
    <div style="display:flex;gap:8px">
      <button id="copyLinkBtn" class="btn">Copy link</button>
      <button id="favBtn" class="btn">Save</button>
      <button id="closeBtn" class="btn">Close</button>
    </div>
  </div>
  <div id="dlg-body" class="dlg-body" tabindex="0"></div>
</dialog>

<div class="fab"><button id="randomBtn" class="btn" title="Random (R)">üé≤ Random</button></div>

<footer class="container footer">¬© <span id="year"></span> CF Stories ‚Ä¢ Aotearoa.</footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
const $=id=>document.getElementById(id);
const grid=$("grid"),search=$("search"),seg=$("seg"),reader=$("reader"),
dlgTitle=$("dlg-title"),dlgBody=$("dlg-body"),favBtn=$("favBtn"),
copyLinkBtn=$("copyLinkBtn"),closeBtn=$("closeBtn"),randomBtn=$("randomBtn"),
bar=$("bar"),importBtn=$("importBtn"),exportBtn=$("exportBtn"),clearLocal=$("clearLocal"),
themeBtn=$("themeBtn");

let tag="All";
let favs=new Set(JSON.parse(localStorage.getItem("cf_favs")||"[]"));
let posts=[];

// Theme
(function initTheme(){
  const saved=localStorage.getItem("cf_theme")||"dark";
  if(saved==="light") document.body.classList.add("theme-light");
  themeBtn.onclick=()=>{ const isLight=document.body.classList.toggle("theme-light");
    localStorage.setItem("cf_theme", isLight? "light":"dark"); };
})();

// Markdown renderer (safe-ish)
const esc=s=>s.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));
function mdToHtml(md){
  if(!md) return "";
  md=md.replace(/\r\n?/g,"\n");
  md=md.replace(/`([^`]+?)`/g,(m,code)=>`<code>${esc(code)}</code>`);
  md=md.replace(/^###### (.*)$/gm,"<h6>$1</h6>").replace(/^##### (.*)$/gm,"<h5>$1</h5>")
     .replace(/^#### (.*)$/gm,"<h4>$1</h4>").replace(/^### (.*)$/gm,"<h3>$1</h3>")
     .replace(/^## (.*)$/gm,"<h2>$1</h2>").replace(/^# (.*)$/gm,"<h1>$1</h1>");
  md=md.replace(/^\> (.*)$/gm,"<blockquote>$1</blockquote>");
  md=md.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/_(.+?)_/g,"<em>$1</em>");
  md=md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  md=md.replace(/(?:^|\n)(\s*[-*] .+(?:\n\s*[-*] .+)*)/g,(m,list)=>'<ul>'+list.trim().split(/\n/).map(li=>'<li>'+li.replace(/^\s*[-*] /,'')+'</li>').join('')+'</ul>');
  const blocks=['h1','h2','h3','h4','h5','h6','ul','ol','blockquote','pre'];
  return md.split(/\n{2,}/).map(ch=>{const x=ch.trim(); if(!x) return ''; if(blocks.some(b=>new RegExp('^<'+b+'[\\s>]').test(x))) return x; return '<p>'+x.replace(/\n/g,'<br>')+'</p>';}).join('\n');
}

// Load posts: local override ‚Üí posts.json
(async function load(){
  try{
    const local=localStorage.getItem("cf_posts");
    if(local){ posts=JSON.parse(local); }
    if(!Array.isArray(posts) || posts.length===0){
      const res=await fetch("posts.json",{cache:"no-store"});
      posts=await res.json();
    }
  }catch(e){ posts=[]; }
  if(!Array.isArray(posts)) posts=[];
  renderSeg(); render();
  const id=location.hash.replace("#",""); const found=posts.find(p=>p.id===id); if(found) openReader(found);
})();

function renderSeg(){
  seg.innerHTML="";
  const labels=["All",...new Set(posts.flatMap(p=>p.tags||[])),"Favourites"];
  labels.forEach(l=>{ const b=document.createElement("button"); b.textContent=l; if(l===tag) b.classList.add("active");
    b.onclick=()=>{ tag=l; renderSeg(); render(); }; seg.appendChild(b); });
}

function matches(p,q){
  if(tag==="Favourites" && !favs.has(p.id)) return false;
  if(tag!=="All" && tag!=="Favourites" && !(p.tags||[]).includes(tag)) return false;
  if(!q) return true; q=q.toLowerCase();
  return (p.title||"").toLowerCase().includes(q) || (p.content||"").toLowerCase().includes(q);
}

function render(){
  const q=search.value; grid.innerHTML="";
  posts.filter(p=>matches(p,q)).forEach(p=>{
    const card=document.createElement("div"); card.className="card";
    const wrap=document.createElement("div"); wrap.style.display="flex"; wrap.style.gap="12px"; wrap.style.alignItems="flex-start";
    const icon=document.createElement("div"); icon.style.width="42px"; icon.style.height="42px"; icon.style.borderRadius="14px";
    icon.style.display="grid"; icon.style.placeItems="center"; icon.style.fontWeight="900"; icon.style.background="linear-gradient(135deg,var(--rose),var(--sky))";
    icon.textContent=(p.title||"").split(" ").slice(0,2).map(w=>w[0]).join("").toUpperCase();
    const right=document.createElement("div"); right.style.flex="1";
    const h3=document.createElement("div"); h3.style.fontWeight="800"; h3.style.marginBottom="6px"; h3.textContent=p.title||"(Untitled)";
    const tags=document.createElement("div"); tags.style.display="flex"; tags.style.flexWrap="wrap"; tags.style.gap="6px";
    (p.tags||[]).forEach(t=>{ const b=document.createElement("span"); b.className="badge"; b.textContent=t; tags.appendChild(b); });
    const first=(p.content||"").split(/\n/).find(Boolean)||""; const snippet=first.replace(/[>#*_`]/g,"");
    const para=document.createElement("p"); para.className="muted"; para.style.margin="10px 0 0"; para.textContent=snippet.slice(0,200)+(snippet.length>200?"‚Ä¶":"");
    const row=document.createElement("div"); row.style.display="flex"; row.style.gap="8px"; row.style.marginTop="12px";
    const read=document.createElement("button"); read.className="btn"; read.textContent="Read"; read.onclick=()=>openReader(p);
    const like=document.createElement("button"); like.className="btn"; like.textContent=favs.has(p.id)?"‚òÖ Saved":"‚ô° Save";
    like.onclick=()=>{ if(favs.has(p.id)) favs.delete(p.id); else favs.add(p.id); localStorage.setItem("cf_favs",JSON.stringify([...favs])); like.textContent=favs.has(p.id)?"‚òÖ Saved":"‚ô° Save"; };
    const share=document.createElement("button"); share.className="btn"; share.textContent="Copy link";
    share.onclick=async()=>{ const url=location.origin+location.pathname+"#"+(p.id||""); try{await navigator.clipboard.writeText(url);}catch(e){prompt("Copy this link:",url);} };
    row.append(read,like,share); right.append(h3,tags,para,row); wrap.append(icon,right); card.append(wrap); grid.append(card);
  });
}

// Reader
function openReader(p){
  dlgTitle.textContent=p.title||"(Untitled)";
  dlgBody.innerHTML=mdToHtml(p.content||"");
  reader.showModal(); document.body.style.overflow="hidden"; dlgBody.scrollTop=0;
  favBtn.textContent=favs.has(p.id)?"‚òÖ Saved":"‚ô° Save";
  favBtn.onclick=()=>{ if(favs.has(p.id)) favs.delete(p.id); else favs.add(p.id);
    localStorage.setItem("cf_favs",JSON.stringify([...favs])); favBtn.textContent=favs.has(p.id)?"‚òÖ Saved":"‚ô° Save"; };
  copyLinkBtn.onclick=async()=>{ const url=location.origin+location.pathname+"#"+(p.id||""); try{await navigator.clipboard.writeText(url);}catch(e){prompt("Copy this link:",url);} };
  dlgBody.onscroll=()=>{ const denom=Math.max(1,dlgBody.scrollHeight-dlgBody.clientHeight); const prog=dlgBody.scrollTop/denom; bar.style.width=(prog*100).toFixed(1)+"%"; };
  closeBtn.onclick=closeReader;
}
function closeReader(){ reader.close(); document.body.style.overflow=""; bar.style.width="0%"; }

// Keyboard + search
let t; search.addEventListener("input",()=>{ clearTimeout(t); t=setTimeout(render,120); });
window.addEventListener("keydown",e=>{ if(e.key==="/"){e.preventDefault(); search.focus();} if(e.key.toLowerCase()==="r"){ const i=Math.floor(Math.random()*posts.length); if(posts[i]) openReader(posts[i]); } if(e.key==="Escape"&&reader.open) closeReader(); });

// Import/Export/Reset
importBtn.onclick=async()=>{ const txt=prompt("Paste JSON array of posts here:"); if(!txt) return; try{ const data=JSON.parse(txt); if(!Array.isArray(data)) throw new Error("Not an array"); localStorage.setItem("cf_posts",JSON.stringify(data)); posts=data; renderSeg(); render(); alert("Saved to this device. (Public site still uses posts.json in your repo.)"); }catch(e){ alert("Invalid JSON: "+e.message); } };
exportBtn.onclick=()=>{ const blob=new Blob([JSON.stringify(posts,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="posts.json"; a.click(); URL.revokeObjectURL(a.href); };
clearLocal.onclick=()=>{ localStorage.removeItem("cf_posts"); alert("Local override cleared. Reloading repo posts.json‚Ä¶"); location.reload(); };
</script>
</body>
</html>

      function openPost(post) {
        dlgBody.innerHTML = "<h2>"+post.title+"</h2>"+mdToHtml(post.content);
        reader.showModal();
      }

      const reader = document.getElementById("reader");
      const dlgBody = document.getElementById("dlg-body");
      search.oninput = render;
      render();
    }
    loadPosts();
  </script>
</body>
</html>
